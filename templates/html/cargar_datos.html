{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Inyección de Datos - GamesHub_</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'ranking/home.css' %}">
    <link rel="stylesheet" href="{% static 'ranking/cargar_datos.css' %}">
    <link rel="icon" href="{% static 'ranking/favicon.ico' %}" type="image/x-icon">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>

<body class="cyber-theme">
    <div class="particles"></div>
    <div class="bg-image"></div>

    {% if messages %}
    <div class="sys-alert-container">
        {% for message in messages %}
            <div class="sys-alert sys-{% if message.tags == 'success' %}success{% else %}error{% endif %}">
                <i class="fas {% if message.tags == 'success' %}fa-check-square{% else %}fa-exclamation-triangle{% endif %}"></i>
                {{ message }}
            </div>
        {% endfor %}
    </div>
    {% endif %}

    <nav class="top-nav">
        <div class="brand-title">Games<span class="highlight">Admin</span>_</div>
        <div class="user-terminal">
            <a href="{% url 'admin_view' %}" class="btn-power" title="Volver al Panel">
                <i class="fas fa-arrow-left"></i>
            </a>
        </div>
    </nav>

    <div class="main-wrapper">
        <header class="terminal-header">
            <div class="sys-badge">/// PROTOCOLO DE INYECCIÓN</div>
            <h1 class="mega-title">CARGA DE <span class="neon-text-magenta">DATOS</span></h1>
            <p class="subtitle-text">>_ Sube un archivo CSV para actualizar el clúster en MongoDB.</p>
        </header>

        <div class="upload-module">
            <form method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                <label for="csv_file" class="cyber-dropzone">
                    <i class="fas fa-file-csv upload-icon"></i>
                    <span class="upload-text">>_ SELECCIONAR_PAQUETE .CSV</span>
                    <input type="file" name="csv_file" id="csv_file" accept=".csv" hidden onchange="previewCSV(this)">
                    <div id="file-name" class="file-name-display"></div>
                </label>

                <button type="submit" class="cyber-btn-magenta">
                    <i class="fas fa-upload"></i> INYECTAR DATOS AL CLÚSTER <span class="blink">_</span>
                </button>
            </form>
        </div>

        <div id="preview-container" class="preview-matrix" style="display:none;">
            <h3 class="preview-title">/// DATA_PREVIEW [ROWS: 1-5]</h3>
            <div id="csv-table-wrapper" class="table-responsive"></div>
        </div>
    </div>

    <script>
        function escapeHtml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function previewCSV(input) {
            const file = input.files[0];
            const fileNameDiv = document.getElementById('file-name');
            const previewContainer = document.getElementById('preview-container');
            const tableWrapper = document.getElementById('csv-table-wrapper');

            if (!file) {
                fileNameDiv.innerHTML = "";
                previewContainer.style.display = 'none';
                return;
            }

            fileNameDiv.innerHTML = `<i class="fas fa-paperclip"></i> ${file.name}`;

            Papa.parse(file, {
                preview: 6, // primeras 6 filas
                skipEmptyLines: true,
                complete: function(results) {
                    const rows = results.data;
                    if (!rows || rows.length === 0) {
                        tableWrapper.innerHTML = '<p class="sys-error">ERROR: PAQUETE DE DATOS ILEGIBLE.</p>';
                        previewContainer.style.display = 'block';
                        return;
                    }

                    let html = '<table class="preview-table"><thead><tr>';
                    rows[0].forEach(header => {
                        html += `<th>${escapeHtml(header)}</th>`;
                    });
                    html += '</tr></thead><tbody>';

                    rows.slice(1).forEach(row => {
                        html += '<tr>';
                        row.forEach(value => {
                            const safeValue = escapeHtml(value);
                            const isImageUrl = /^https?:\/\/.+/i.test(value);

                            if (value.startsWith("data:image") || isImageUrl) {
                                html += `<td><img src="${value}" alt="IMG" style="max-width:60px; filter:grayscale(50%);"></td>`;
                            } else {
                                html += `<td>${safeValue}</td>`;
                            }
                        });
                        html += '</tr>';
                    });

                    html += '</tbody></table>';
                    tableWrapper.innerHTML = html;
                    previewContainer.style.display = 'block';
                }
            });
        }

        // Efecto visual para que las alertas desaparezcan al estilo terminal
        setTimeout(function() {
            const alerts = document.querySelectorAll('.sys-alert');
            alerts.forEach(alert => {
                alert.style.transition = "opacity 0.5s ease, transform 0.5s ease";
                alert.style.opacity = "0";
                alert.style.transform = "translateX(50px)";
                setTimeout(() => alert.remove(), 500);
            });
        }, 4000);
    </script>
</body>
</html>